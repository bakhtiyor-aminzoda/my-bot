<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Amini CRM</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #F5F7FA;
            --card-bg: #FFFFFF;
            --text-primary: #1A1F36;
            --text-secondary: #6B7280;
            --accent-color: #3B82F6;
            --accent-hover: #2563EB;
            --danger-color: #EF4444;
            --success-color: #10B981;

            --col-new-bg: #E0F2FE;
            --col-new-text: #0369A1;

            --col-progress-bg: #FEF3C7;
            --col-progress-text: #B45309;

            --col-done-bg: #DCFCE7;
            --col-done-text: #15803D;

            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        /* Dark Mode Support via Telegram Params */
        body.dark-mode {
            --bg-color: #111827;
            --card-bg: #1F2937;
            --text-primary: #F9FAFB;
            --text-secondary: #9CA3AF;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            /* Prevent scrolling body inside TG */
        }

        header {
            padding: 16px;
            background: var(--card-bg);
            box-shadow: var(--shadow-sm);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }

        h1 {
            font-size: 18px;
            font-weight: 700;
            margin: 0;
            color: var(--accent-color);
        }

        .board-container {
            display: flex;
            overflow-x: auto;
            overflow-y: hidden;
            flex-grow: 1;
            padding: 16px;
            gap: 16px;
            scroll-snap-type: x mandatory;
        }

        .column {
            min-width: 280px;
            width: 85vw;
            max-width: 320px;
            background: rgba(255, 255, 255, 0.5);
            /* Glass-ish */
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            scroll-snap-align: center;
            height: 100%;
        }

        .column-header {
            padding: 12px;
            font-weight: 600;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
        }

        .col-new .column-header {
            background: var(--col-new-bg);
            color: var(--col-new-text);
        }

        .col-progress .column-header {
            background: var(--col-progress-bg);
            color: var(--col-progress-text);
        }

        .col-done .column-header {
            background: var(--col-done-bg);
            color: var(--col-done-text);
        }

        .count-badge {
            background: rgba(255, 255, 255, 0.4);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
        }

        .task-list {
            flex-grow: 1;
            overflow-y: auto;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .card {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 12px;
            box-shadow: var(--shadow-sm);
            cursor: grab;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 1px solid transparent;
        }

        .card:active {
            cursor: grabbing;
        }

        .card.sortable-ghost {
            opacity: 0.4;
            background: #E5E7EB;
        }

        .card.sortable-drag {
            background: var(--card-bg);
            box-shadow: var(--shadow-md);
            transform: scale(1.02);
            opacity: 1;
        }

        .card-title {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 4px;
        }

        .card-desc {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .card-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 8px;
            border-top: 1px solid #F3F4F6;
            padding-top: 8px;
        }

        .card-price {
            font-weight: 600;
            color: var(--accent-color);
        }

        .btn-analyze {
            background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            border: none;
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .card-actions {
            display: flex;
            align-items: center;
        }

        .ai-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }

        /* Floating AI Action Button */
        .fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--text-primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-md);
            font-size: 24px;
            cursor: pointer;
            z-index: 100;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 200;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--card-bg);
            width: 100%;
            max-width: 400px;
            border-radius: 16px;
            padding: 20px;
            box-shadow: var(--shadow-md);
        }
    </style>
</head>

<body>

    <header>
        <h1>Smart CRM üß†</h1>
        <div id="user-name" style="font-size: 12px; font-weight: 500;">Admin</div>
    </header>

    <div class="board-container">
        <!-- Column 1: New -->
        <div class="column col-new">
            <div class="column-header">
                <span>üî• –ù–æ–≤—ã–µ</span>
                <span class="count-badge" id="count-new">0</span>
            </div>
            <div class="task-list" id="list-new" data-status="new">
                <!-- Cards will be injected here -->
            </div>
        </div>

        <!-- Column 2: In Progress -->
        <div class="column col-progress">
            <div class="column-header">
                <span>‚è≥ –í —Ä–∞–±–æ—Ç–µ</span>
                <span class="count-badge" id="count-pending">0</span>
            </div>
            <div class="task-list" id="list-progress" data-status="in_progress">
                <!-- Cards here -->
            </div>
        </div>

        <!-- Column 3: Done -->
        <div class="column col-done">
            <div class="column-header">
                <span>‚úÖ –ì–æ—Ç–æ–≤–æ</span>
                <span class="count-badge" id="count-done">0</span>
            </div>
            <div class="task-list" id="list-done" data-status="completed">
                <!-- Cards here -->
            </div>
        </div>
    </div>

    <!-- AI FAB -->
    <div class="fab" onclick="Telegram.WebApp.showAlert('AI Assistant coming soon!')">‚ú®</div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // Dark mode handling
        if (tg.colorScheme === 'dark') {
            document.body.classList.add('dark-mode');
        }

        async function analyzeOrder(orderId, event) {
            event.stopPropagation(); // Prevent card click
            const btn = event.target;
            btn.textContent = "ü§î Thinking...";
            btn.disabled = true;

            try {
                const headers = { 'X-Telegram-User': '6066116812' };
                const res = await fetch(`/api/orders/${orderId}/analyze`, { method: 'POST', headers });
                const data = await res.json();

                if (data.analysis) {
                    tg.HapticFeedback.notificationOccurred('success');
                    fetchOrders(); // Refresh UI
                } else {
                    btn.textContent = "‚ùå Error";
                }
            } catch (e) {
                console.error("Analyze failed:", e);
                btn.textContent = "‚ùå Error";
            }
        }

        async function fetchOrders() {
            try {
                // Add admin header mockup (in prod use initData)
                const headers = { 'X-Telegram-User': '6066116812' }; // Hardcoded ADMIN_ID for demo
                const response = await fetch('/api/bookings', { headers });
                const orders = await response.json();
                renderCards(orders);
            } catch (e) {
                console.error("Failed to fetch orders:", e);
                // Fallback to empty or show error
            }
        }

        async function updateStatus(orderId, newStatus) {
            try {
                const headers = {
                    'X-Telegram-User': '6066116812',
                    'Content-Type': 'application/json'
                };
                await fetch(`/api/orders/${orderId}/status`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({ status: newStatus })
                });
                tg.HapticFeedback.notificationOccurred('success');
            } catch (e) {
                console.error("Update failed:", e);
                tg.HapticFeedback.notificationOccurred('error');
            }
        }

        function renderCards(orders) {
            // Clear lists
            document.getElementById('list-new').innerHTML = '';
            document.getElementById('list-progress').innerHTML = '';
            document.getElementById('list-done').innerHTML = '';

            let counts = { new: 0, in_progress: 0, completed: 0 };

            orders.forEach(order => {
                const card = document.createElement('div');
                card.className = 'card';
                card.setAttribute('data-id', order.id);

                // Map API fields to UI
                // API: id, client, service, budget, desc, status, ai_summary
                const aiSummary = order.ai_summary;

                card.innerHTML = `
                    <div class="card-title">${order.client}</div>
                    <div class="card-desc">${order.desc || order.service}</div>
                    <div class="card-meta">
                        <span class="card-price">${order.budget || '-'}</span>
                        <div class="card-actions">
                            ${aiSummary ? `<span class="ai-badge">‚ú® ${aiSummary}</span>` :
                        `<button class="btn-analyze" onclick="analyzeOrder('${order.id}', event)">‚ö° Analyze</button>`}
                        </div>
                    </div>
                `;

                // Status mapping logic
                // API statuses: new, in_progress, completed, cancelled, negotiation_pending
                // We map them to our 3 columns
                let listId = 'list-new';
                let colStatus = 'new';

                if (['in_progress', 'negotiation_pending'].includes(order.status)) {
                    listId = 'list-progress';
                    colStatus = 'in_progress';
                }
                if (['completed', 'cancelled'].includes(order.status)) {
                    listId = 'list-done';
                    colStatus = 'completed';
                }

                document.getElementById(listId).appendChild(card);

                // Count
                if (counts[colStatus] !== undefined) counts[colStatus]++;
            });

            // Update badges
            document.getElementById('count-new').textContent = counts.new;
            document.getElementById('count-pending').textContent = counts.in_progress;
            document.getElementById('count-done').textContent = counts.completed;
        }

        // Initialize Sortable
        ['list-new', 'list-progress', 'list-done'].forEach(id => {
            new Sortable(document.getElementById(id), {
                group: 'kanban',
                animation: 150,
                ghostClass: 'sortable-ghost',
                dragClass: 'sortable-drag',
                delay: 100,
                delayOnTouchOnly: true,
                onEnd: function (evt) {
                    const itemEl = evt.item;
                    const newColStatus = evt.to.getAttribute('data-status'); // new, in_progress, completed
                    const orderId = itemEl.getAttribute('data-id');

                    console.log(`Moved ${orderId} to ${newColStatus}`);
                    updateStatus(orderId, newColStatus);
                }
            });
        });

        // Init
        fetchOrders();
        // Poll every 10 seconds for updates
        setInterval(fetchOrders, 10000);

    </script>
</body>

</html>